<?php
require_once '../conexao.php';
$id_cliente = 689;
// recupera o ultimo id da sequenciador do sia prevenda
$sql2 = "SELECT * FROM sys_sequenciador s WHERE s.TABELA = 'PREVENDA'";
$sql2 = $conexao->prepare($sql2);
$sql2->execute();
$prevenda_id = $sql2->fetchAll(PDO::FETCH_ASSOC);

$id_proximo_pedido = $prevenda_id[0]['VALOR'] + 1;

// recupera os dados do cliente
$sql3 = "SELECT * FROM clientes c WHERE c.CODIGOCLI =:idcliente ";
$sql3 = $conexao->prepare($sql3);
$sql3->bindValue(':idcliente',$id_cliente);
$sql3->execute();
$cliente = $sql3->fetchAll(PDO::FETCH_ASSOC);
// print_r($cliente[0]);

// apos os dados recuperados, hora de percistir os dados do carrinho para setar como finalizado e colocar o valor final dos itens
$sql5 = "
SELECT SUM(ic.TOTAL) FROM carrinho_ecommerce c 
JOIN itens_carrinho_ecommerce ic
ON c.ID = ic.ID_CARRINHO_ECOMMERCE WHERE c.ID_CLIENTE =:idcliente AND c.`STATUS` = 'A' AND c.ID =:id_pedido_cliente";
$sql5 = $conexao->prepare($sql5);
$sql5->bindValue(':id_pedido_cliente',$id_pedido_cliente);
$sql5->bindValue(':idcliente',$idcliente);
$sql5->execute();
$total_produtos_carrinho = $sql5->fetchAll(PDO::FETCH_ASSOC);

// insere o valor final do carrinho na tabela


$sql4 = "SELECT * FROM carrinho_ecommerce" ;



// -- INSERT prevenda
$sql4 = "INSERT INTO `prevenda` (
`EMPRESA`,
 `VENDA`, 
 `TIPOVENDA`, 
 `CODIGOCLI`, 
 `NOMECLI`, 
 `ENDERCLI`, 
 `BAIRROCLI`, 
 `CIDADECLI`, 
 `ESTADOCLI`, 
 `CEPCLI`, 
 `FONECLI`, 
 `VLR_DESCONTO`, 
 `VLRTOTAL`, 
 `CPFCGC`, 
 `IDENINSC`, 
 `APROVADO`, 
 `DATAAPROV`, 
 `TIPOAPROV`, 
 `SITUACAO`, 
 `EMISSAO`, 
 `OBSERVACAO`, 
 `FORMAPAGTO`, 
 `ID_VENDEDOR`, 
 `STATUS`, 
 `ID_PLANOPGTO`, 
 `ID_FORMAPGTO`, 
 `ID_TIPOPEDIDO`, 
 `CANCELADO`, 
 `ENTRADA`, 
 `VALOR_ENTRADA`, 
 `ENTRADA_PAGA`, 
 `DATA_ENTRADA`, 
 `OUTRO_DESC`, 
 `OUTRO_DESC_ORIGINAL`, 
 `ACRESCIMO`, 
 `ACRESCIMO_ORIGINAL`, 
 `ID_PREVENDA`, 
 `ID_DAV`, 
 `CAIXA`, 
 `CUPOM`, 
 `STATUSPAF`, 
 `SELECIONADO`, 
 `ID_DAVSTR`, 
 `ID_PREVENDASTR`, 
 `NOTA`, 
 `SERIE`, 
 `NOTAIMPRESSA`, 
 `BASEDECALCULO`, 
 `VALORICMS`, 
 `BASEST`, 
 `VALORICMSST`, 
 `TOTALSERVICOS`, 
 `VALORFRETE`, 
 `VALORSEGURO`, 
 `VALORDESPESAS`, 
 `VALORIPI`, 
 `ID_TRANSPORTADOR`, 
 `PLACA`, 
 `FRETEPORCONTA`, 
 `QUANTIDADE`, 
 `ESPECIE`, 
 `MARCA`, 
 `PESOBRUTO`, 
 `PESOLIQUIDO`, 
 `VALORISS`, 
 `ALIQUOTAISS`, 
 `BASEISS`, 
 `CARIMBO`, 
 `INFOADICIONAL`, 
 `FATURAMENTOIMPRESSO`, 
 `DATAENTREGA`, 
 `DATAGERACAONF`, 
 `ID_AUTORIZADO`, 
 `ID_USUARIOCADASTRO`, 
 `DEVOLVIDO`, 
 `DATADEVOLUCAO`, 
 `NFDEVOLUCAO`, 
 `SERIEDEVOLUCAO`, 
 `ENTREGAR`, 
 `LOCALENTREGADIF`, 
 `ENDERECOENTREGA`, 
 `BAIRROENTREGA`, 
 `CIDADEENTREGA`, 
 `ESTADOENTREGA`, 
 `CEPENTREGA`, 
 `TELEFONEENTREGA`, 
 `CONTATOENTREGA`, 
 `CCF`, 
 `ID_PEDIDOPALM`, 
 `DATA_VISITA`, 
 `ENTREGUE`, 
 `DTRECEBIMENTOENTREGA`, 
 `HORARECEBIMENTOENTREGA`, 
 `OBSERVACAO_ENTREGA`, 
 `ID_VENDEDOR_EXTERNO`, 
 `RETIRADOPOR`, 
 `HORA`, 
 `MD5`, 
 `BASEPIS`, 
 `VL_PIS`, 
 `BASECOFINS`, 
 `VL_COFINS`, 
 `IMPRESSO`, 
 `PARTICIPAPISCOFINS`, 
 `IDROMANEIO`, 
 `UF`, 
 `VL_PIS_ST`, 
 `VL_COFINS_ST`, 
 `RECEBIDO`, 
 `DTRECEBIMENTO`, 
 `RECEBIMENTOOK`, 
 `ID_PEDIDOCOMPRA`, 
 `VALIDADE_ORCAMENTO`, 
 `ID_PROFISSIONAL`, 
 `ID_ROTA`, 
 `LIBERADO`, 
 `USUARIO_LIBERACAO`, 
 `DATA_LIBERACAO`, 
 `FRETE`, 
 `USUARIOGERENCIA`, 
 `LIBERADOGERENCIA`, 
 `DATALIBERACAOGERENCIA`, 
 `SIMPLES_REMESSA`, 
 `ID_ADM`, 
 `EDITADOGERENCIA`, 
 `SALDODC`, 
 `STATUS_CAIXA_OPERADOR`, 
 `SOLUCAO_PENDENCIA`, 
 `ID_USUARIO_CAIXA_OPERADOR`, 
 `SELECAO`, 
 `CORPORATIVO`, 
 `ID_CARIMBO_OBS`, 
 `ID_CARIMBO_ADICIONAIS`, 
 `ID_CARIMBO`, 
 `DATA_TRANSACAO`, 
 `ID_FORMAPGTO_ENTRADA`, 
 `ID_ADM_ENTRADA`, 
 `NUMDOC_ENTRADA`, 
 `NUM_PARCELAS_ENTRADA`, 
 `TIPO_ENTRADA`, 
 `ID_PLANOCONTA`, 
 `VFCP_TOT`, 
 `VFCPUFDEST_TOT`, 
 `VICMSUFDEST_TOT`, 
 `VICMSUFREMET_TOT`, 
 `VFCPST_TOT`, 
 `VFCPSTRET_TOT`, 
 `ID_MEIO_PGTO_CAB`, 
 `INDICADOR_PRESENCA`, 
 `IDDEST`, 
 `BASE_IPI`, 
 `CONSUMO_FINAL`, 
 `DESTINO_DEMONSTRACAO`, 
 `ACRESCIMO_PROMOCIONAL_PL_PGTO`, 
 `ACRESCIMO_PL_PGTO`, 
 `VICMSDESON_TOT`, 
 `INCIDE_IPI_BC_ICMS`, 
 `DESCONTAR_DESONERADO`, 
 `ID_USUARIO_EDICAO`, 
 `NFCE`, 
 `PLANO_ALTERADO`, 
 `TEXTO_COMP_OBS`, 
 `STATUS_APROVACAO`, 
 `GPS_LONGITUDE`, 
 `GPS_LATITUDE`, 
 `ADM_ECOMMERCE`, 
 `PARCELAS_ECOMMERCE`, 
 `PEDIDO_EXPOSICAO`, 
 `DESPESAS_BOLETO`, 
 `ID_INTERMEDIADOR`, 
 `VLR_ENTREGA_ECOMMERCE`, 
 `VLR_MEIO_PGTO_ECOMMERCE`, 
 `VLR_COMISSAO_ECOMMERCE`, 
 `ID_PEDIDO_ORIGEM`, 
 `ID_PEDIDO_ECOMMERCE`, 
 `TIPO_ECOMMERCE`, 
 `ID_VENDA_PDV_ECOMMERCE`, 
 `ORCAMENTO_PDV`, 
 `VALORCONTRATO`, 
 `ID_CONFERENCIA`
 ) VALUES (
 1, 
 2, 
 '', 
 689, 
 'INOVEH SOLUCOES AUTOMACAO COMERCIAL LTDA. - ME', 
 'RUA JOAO BASILIO262', 
 'CENTRO', 
 'POUSO ALEGRE', 
 'MG', 
 '37550000', 
 '3534212407', 
 0.00, 
 10.00, 
 '20949563000138', 
 '0024740390035', 
 'N', 
 NULL, 
 '', 
 'N', 
 '2023-10-13', 
 NULL, 
 NULL, 
 1, 
 '1', 
 1, 
 1, 
 10, 
 'N', 
 'N', 
 0.00, 
 'N', 
 NULL, 
 0.00, 
 0.00, 
 0.00, 
 0.00, 
 0, 
 0, 
 0, 
 0, 
 'N', 
 NULL, 
 NULL, 
 NULL, 
 0, 
 NULL, 
 'N', 
 0.00, 
 0.00, 
 0.00, 
 0.00, 
 0.00, 
 0.00, 
 0.00, 
 0.00, 
 0.00, 
 NULL, 
 NULL, 
 9, 
 1.000, 
 'VOLUMES', 
 NULL, 
 0.000, 
 0.000, 
 0.00, 
 0.00, 
 0.000, 
 NULL, 
 NULL, 
 'N', 
 '2023-10-13', 
 NULL, 
 NULL, 
 1000000, 
 'N', 
 NULL, 
 NULL, 
 NULL, 
 'S', 
 'N', 
 'RUA JOAO BASILIO,262', 
 'CENTRO', 
 'POUSO ALEGRE', 
 'MG', 
 '37550000', 
 '3534212407', 
 NULL, 
 NULL, 
 NULL, 
 NULL, 
 'N', 
 NULL, 
 NULL,
 NULL, 
 NULL, 
 'O PROPRIO', 
 '17:12:57', 
 NULL, 
 0.00, 
 0.00, 
 0.00, 
 0.00, 
 'N', 
 'S', 
 NULL, 
 NULL, 
 0.00, 
 0.00, 
 'N', 
 NULL, 
 'N', 
 NULL, 
 '2023-10-23', 
 1, 
 0, 
 'N', 
 NULL, 
 NULL, 
 0.00, 
 NULL, 
 'N', 
 NULL, 
 'N', 
 NULL, 
 'N', 
 0.00, 
 'X', 
 NULL, 
 NULL, 
 'N', 
 'N', 
 NULL, 
 NULL, 
 NULL, 
 NULL, 
 NULL, 
 NULL, 
 NULL, 
 NULL, 
 NULL, 
 1, 
 0.00, 
 0.00, 
 0.00,
 0.00, 
 0.00, 
 0.00, 
 NULL, 
 1, 
 NULL, 
 0.00, 
 'N', 
 NULL, 
 0.000, 
 0.000, 
 0.00, 
 'N', 
 'N', 
 1000000, 
 0, 
 'N', 
 NULL, 
 1, 
 NULL, 
 NULL, 
 NULL, 
 0, 
 'N', 
 0.00, 
 NULL, 
 NULL, 
 NULL, 
 NULL, 
 0, 
 '0', 
 0, 
 0, 
 'N', 
 0.00, 
 0
 )";
$sql5 =
    "INSERT INTO `produtos_prevenda` (
    `PRIMARIA`, 
    `EMPRESA`, 
    `VENDA`, 
    `CODIGO`, 
    `DESCRICAO`, 
    `UNIDADE`, 
    `QTDE`, 
    `UNITARIO`, 
    `ALIQUOTA`, 
    `CUSTO`, 
    `ID_PRODUTO`, 
    `TOT_ITEM`, 
    `DESCONTO`, 
    `TOTALDESCONTO`, 
    `DESC_RATEIO`, 
    `ENCARGO_RATEIO`, 
    `PRECOVENDA`, 
    `PESOLIQUIDO`, 
    `PESOBRUTO`, 
    `COMISSAO`, 
    `INFOADICIONAL`, 
    `DADOADICIONAL`, 
    `CFOP`, 
    `BASEDECALCULO`, 
    `ALIQUOTAICMS`, 
    `VALORICMS`, 
    `CST`, 
    `FATURADO`, 
    `VALORIPI`, 
    `DIFEUNITARIOVENDA`, 
    `IMPOSTO`, 
    `CONFERIDO`, 
    `TOTALBRUTO`, 
    `DEVOLVIDO`, 
    `CUSTOREAL`, 
    `CUSTOOPERACIONAL`, 
    `PRECO_CONCORRENTE`, 
    `MD5`, 
    `CANCELADO`, 
    `BASEPIS`, 
    `ALIQUOTAPIS`, 
    `VL_PIS`, 
    `BASECOFINS`, 
    `ALIQUOTACOFINS`, 
    `VL_COFINS`, 
    `ALIQ_ECF`, 
    `ID_DAV`, 
    `NUMERO_ITEM`, 
    `EMISSAO`, 
    `CST_PIS`, 
    `CST_COFINS`, 
    `SIT_TRIBUTARIA`, 
    `QTD_DEVOLVIDA`, 
    `MARKUP`, 
    `PRECOINICIAL`, 
    `SALDO_PRODUTO`, 
    `ID_TONALIDADE`, 
    `PRODUTO_PROMOCAO`, 
    `FRETE_RATEIO`, 
    `ACRESCIMO`, 
    `EDITADOGERENCIA`, 
    `UNITARIOBASE`, 
    `CSOSN`, 
    `ORIGEM_PRODUTO`, 
    `PROTOCOLO_ENTRE_ESTADOS`, 
    `VBCFCPUFDEST`, 
    `VBCUFDEST`, 
    `PFCPUFDEST`, 
    `PICMSUFDEST`, 
    `PICMSINTER`, 
    `PICMSINTERPART`, 
    `VFCPUFDEST`, 
    `VICMSUFDEST`, 
    `VICMSUFREMET`, 
    `VBCFCPST`, 
    `PFCPST`, 
    `VFCPST`, 
    `VBCFCPSTRET`, 
    `PFCPSTRET`, 
    `VFCPSTRET`, 
    `VFCP`, 
    `PFCP`, 
    `VBCFCP`, 
    `REDUCAO`, 
    `BASESUBSTITUICAO`, 
    `ICMSST`, 
    `REDUCAOST`,
    `MVA`, 
    `ALIQUOTAINTERNA_DEST`, 
    `vBCSTRet`, 
    `vICMSSTRet`, 
    `pST`, 
    `pCREDSN`, 
    `vCREDICMSSN`, 
    `BASE_IPI`, 
    `ALIQUOTA_IPI`, 
    `CST_IPI`, 
    `ID_ALIQUOTA`, 
    `UTRIB`, 
    `QTRIB`, 
    `VUNTRIB`, 
    `DISPENSAESTORNOCREDITO`, 
    `ACRESCIMO_PROMOCIONAL_PL_PGTO`, 
    `ACRESCIMO_PL_PGTO`, 
    `VICMSDESON`, 
    `MOTDESICMS`, 
    `COD_BENEFICIO`, 
    `ICMSSUBSTITUTO`, 
    `PEDIDOCLIENTE`, 
    `ITEMPEDIDOCLIENTE`, 
    `ID_PEDIDO_ECOMMERCE`, 
    `DESPESAS_BOLETO`, 
    `QTD_ENTREGUE`, 
    `ID_TINTOMETRIA`, 
    `FORMULA_TINTOMETRIA`, 
    `ID_PRODUCAO`, 
    `ID_PLANOCONTA_ITEM`
    ) VALUES (
    2, 
    1, 
    2, 
    '07897511711098', 
    'EMBALAGEM - G 742M/200UN - POTE REDONDO MILLENIUM 250', 
    'UN', 
    1.000, 
    10.000, 
    2, 
    0.32, 
    3, 
    10.00, 
    0.00, 
    0.00, 
    0.00, 
    0.00, 
    10.000, 
    0.000, 
    0.000, 
    0.000, 
    NULL, 
    NULL, 
    NULL, 
    0.00, 
    0.00, 
    0.00, 
    NULL, 
    'S', 
    0.00, 
    0.00, 
    0.00, 
    'N', 
    10.00, 
    'N', 
    0.323, 
    0.323, 
    0.00,
     NULL, 
     'N', 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     2, 
     0, 
     1, 
     '2023-10-13', 
     NULL,
     NULL, 
     NULL, 
     0.000, 
     2995.98, 
     10.000, 
     0.000, 
     NULL, 
     'N', 
     0.00, 
     0.00, 
     'N', 
     10.000, 
     NULL, 
     NULL, 
     NULL, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00, 
     0.00,
     0.00, 
     0.00, 
     0, 
     2, 
     NULL, 
     0.0000, 
     0, 
     'N', 
     0.000, 
     0.000, 
     0.00, 
     0, 
     NULL, 
     0.00, 
     NULL, 
     NULL, 
     NULL, 
     0.00, 
     0.000,
     NULL,
     NULL, 
     0, 
     NULL
     );
    ";
